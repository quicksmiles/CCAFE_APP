<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Project Plan: Integrating R Methods into Python with Celery and Redis</title>
    <style>
        body {
            font-family: Arial, serif;
            line-height: 1.6;
            margin: 20px;
            padding: 0;
            color: #333;
        }
        h1, h2, h3, h4 {
            color: #0056b3;
        }
        pre, code {
            background-color: #f4f4f4;
            padding: 10px;
            border: 1px solid #ccc;
            margin: 10px 0;
            display: block;
        }
        .diagram {
            border: 1px solid #ccc;
            padding: 20px;
            margin: 20px 0;
            background-color: #f9f9f9;
        }
    </style>
</head>
<body>

    <h1>Project Plan: Integrating R Methods into Python</h1>

    <p>This project involves building a system where users can upload GWAS summary statistics files, query allele frequencies from gnomAD using Hail, merge the data, and apply R-based methods within Python. The system architecture leverages task queues using Celery and Redis for handling asynchronous tasks, and Docker Compose for resource-efficient deployment. The project will run on a Google Cloud Platform virtual machine.</p>

    <h2>System Overview</h2>
    <p>The project consists of the following components:</p>
    <ul>
        <li>Flask web server to handle user file uploads and requests.</li>
        <li>Task queue system (Celery and Redis) to manage long-running tasks asynchronously.</li>
        <li>Hail queries to gnomAD for retrieving allele frequencies based on chromosome and position.</li>
        <li>R methods applied to merged GWAS and gnomAD data via rpy2 or script execution.</li>
        <li>Data purging after processing to ensure user privacy.</li>
        <li>Docker Compose for containerized deployment.</li>
    </ul>

    <h2>Key Components</h2>

    <h3>1. Flask Web Server</h3>
    <p>The web server will handle incoming user requests and manage file uploads. Once a user uploads their GWAS summary statistics file, it passes off the processing work to Celery workers.</p>

    <h3>2. Task Queue in System Architecture (Celery/Redis)</h3>
    <p>The <strong>task queue</strong> plays a critical role in managing long-running tasks, such as querying gnomAD, merging large datasets, and applying R methods, in an asynchronous manner. This allows the web server to remain responsive while handling potentially slow operations in the background.</p>

    <h4>Why Use a Task Queue?</h4>
    <p>In this project, querying gnomAD and merging large GWAS datasets can take considerable time, especially with larger files. Instead of blocking the web server while waiting for these tasks to complete, the task queue offloads them to a separate worker process. This ensures that the web server can continue to handle new user requests without being tied up by long operations.</p>

    <h3>How Celery and Redis Work Together</h3>

    <h4>Celery:</h4>
    <ul>
        <li><strong>Celery</strong> is a distributed task queue that allows Python functions to run asynchronously (in the background). It's used to handle heavy tasks (like data processing) outside the main web server process.</li>
        <li>In this system, Celery will be responsible for:
            <ul>
                <li>Running the Hail queries against gnomAD.</li>
                <li>Merging the GWAS and gnomAD data.</li>
                <li>Invoking R scripts to process the merged data.</li>
                <li>Deleting the user’s uploaded data after the task completes.</li>
            </ul>
        </li>
    </ul>

    <h4>Redis:</h4>
    <ul>
        <li><strong>Redis</strong> is used as a message broker for Celery. It stores messages (tasks) that need to be processed and ensures they are delivered to the right workers.</li>
        <li>Redis will handle the communication between the web server and the Celery workers, managing task queues, and ensuring tasks are executed in the background.</li>
    </ul>

    <h4>Flow of Task Execution:</h4>
    <ol>
        <li><strong>User Uploads GWAS File:</strong>  
        The web server receives the GWAS file and immediately delegates the heavy-lifting tasks (e.g., querying gnomAD, merging, running R methods) to Celery.</li>
        <li><strong>Celery Worker Picks Up the Task:</strong>  
        The task (querying gnomAD, merging files, running R methods) is placed in the task queue (Redis). A Celery worker picks up the task and starts processing it in the background.</li>
        <li><strong>Task Execution:</strong>  
        The worker executes the task in the background, such as fetching data from gnomAD, merging it with the GWAS file, and applying R methods.</li>
        <li><strong>Result Returned:</strong>  
        Once the task is complete, the result is either stored temporarily or returned to the web server to be sent back to the user. Afterward, the user's data is purged.</li>
        <li><strong>Data Purging:</strong>  
        After the R methods are applied and the output is returned to the user, the worker deletes the user’s data from the system to ensure privacy.</li>
    </ol>

    <h3>3. R Method Execution via Scripts</h3>
    <p>The <strong>integration of R methods</strong> within Python will rely on either:</p>
    <ul>
        <li><strong>rpy2</strong> (for direct R calls in Python).</li>
        <li><strong>Executing R Scripts</strong> via subprocess calls from Python.</li>
    </ul>

    <h4>Why Use R Scripts?</h4>
    <p>Although rpy2 provides a direct interface to call R functions from Python, there are situations where:</p>
    <ul>
        <li>The R environment may be complex (e.g., specific R libraries that are easier to run in an isolated script).</li>
        <li>Certain tasks may be better organized in standalone scripts for better modularity, easier debugging, or reuse.</li>
    </ul>

    <h4>Steps to Implement R Scripts in Python:</h4>
    <ol>
        <li><strong>Prepare the Merged Data:</strong>  
        After merging the GWAS and gnomAD data, save the resulting data to a CSV or a similar format that can be passed to the R script.</li>
        <li><strong>Trigger R Script Execution:</strong>  
        Use Python’s <code>subprocess</code> module to call R scripts. Example:
        <pre><code>import subprocess
result = subprocess.run(["Rscript", "my_script.R", "input_data.csv", "output_data.csv"], capture_output=True)</code></pre>
        </li>
        <li><strong>Process the Output:</strong>  
        After the R script completes, the resulting data can be loaded back into Python for further use or returned to the user.</li>
        <li><strong>Data Cleanup:</strong>  
        Ensure that after the R script finishes, both the input (uploaded data) and any temporary files are deleted from the system.</li>
    </ol>

    <h3>R Script Example:</h3>

    <pre><code># my_script.R
args <- commandArgs(trailingOnly = TRUE)
input_file <- args[1]
output_file <- args[2]

# Read the input CSV file
data <- read.csv(input_file)

# Apply some R-based methods (e.g., statistical analysis, allele frequency estimation)
# Example: Simple allele frequency computation
data$allele_frequency <- data$allele_count / data$total_count

# Write the processed data to output
write.csv(data, output_file, row.names = FALSE)</code></pre>

    <h2>Architecture Diagram</h2>

    <div class="diagram">
        <pre><code>+------------------+             +---------------------+           +-------------------+
|                  |             |                     |           |                   |
|   Flask Web      |   Uploads   |  Task Queue (Celery) |  Executes |   Celery Worker    |
|   Server         +------------>+  & Redis             +---------->+   (Hail, Rpy2)     |
|   (User Upload)  |             |  Manages Tasks       |           |   Processes Task   |
+------------------+             +---------------------+           +--------+----------+
                                                             Queries          |
                                                             gnomAD           |
                                                                |             |
                                                                v             |
                                                      +------------------+    |
                                                      |                  |    |
